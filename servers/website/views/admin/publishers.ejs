<% include ../includes/start %>
<% include ../includes/header %>
<% 
  active_publishers = publishers.filter(function(publisher) {
    return publisher.is_activated
  }).length
  
  miza_endpoints = publishers.filter(function(publisher) {
    return publisher.miza_endpoint
  }).length
  
  discounts_given = publishers.filter(function(publisher) {
    return publisher.fee < 1 && publisher.fee > 0
  }).length
  
  free_publishers = publishers.filter(function(publisher) {
    return publisher.fee == 0
  }).length
%>
<div class="container form-table">
  <div class="stats">
    <span>
      <strong>Activated</strong>
      (<%= active_publishers %>)
    </span>
    <span>
      <strong>Not Activated</strong>
      (<%= publishers.length - active_publishers %>)
    </span>
    <span>
      <strong>Miza Endpoints Issued</strong>
      (<%= miza_endpoints %>)
    </span>
    <span>
      <strong>Discounts Given</strong>
      (<%= discounts_given %>)
    </span>
    <span>
      <strong>Free Tier</strong>
      (<%= free_publishers %>)
    </span>
  </div>
  <form class="form" method="POST" action="/admin/publishers">
    <% include ../includes/csrf %>
    <table>
      <head>
        <tr>
          <th></th>
          <th>Name</th>
          <th>Domain</th>
          <th>Industry</th>
          <th>Activated</th>
          <th>Admin Contact</th>
          <th class="dynamic">Miza Endpoint</th>
          <th class="dynamic number">Coverage (%)</th>
          <th class="dynamic number">Fee (%)</th>
        </tr>
      </head>
      <tbody>
        <% publishers.forEach(function(publisher, i) { %>
          <input type="hidden" name="publishers[<%= i %>][id]" value="<%= publisher.id %>" required>
          <tr>
            <td><%= i + 1 %></td>
            <td><a href="/dashboard/<%= publisher.key %>/analytics"><%= publisher.name %></a></td>
            <td><a target="_blank" href="http://<%= publisher.domain %>"><%= publisher.domain %></a></td>
            <td><%= publisher.industry.name %></td>
            <td class="<%= publisher.is_activated ? "green" : "red" %>"><%= publisher.is_activated ? "Activated" : "Not Activated" %></td>
            <td><%= publisher.admin_contact ? publisher.admin_contact.name : "" %></td>
            <td>
              <div class="group">
                <div class="fa fa-sort"></div>
                <select class="input only" name="publishers[<%= i %>][miza_endpoint]" required>
                  <option value="false" <%= !publisher.miza_endpoint ? "selected" : "" %>>No</option>
                  <option value="true" <%= publisher.miza_endpoint ? "selected" : "" %>>Yes</option>
                </select>
              </div>
            </td>
            <td><input class="only number" type="number" name="publishers[<%= i %>][coverage]" value="<%= publisher.coverage_ratio * 100 %>" placeholder="Coverage" min="0" step="1" max="100" required></td>
            <td><input class="only number" type="number" name="publishers[<%= i %>][fee]" value="<%= publisher.fee * 100 %>" placeholder="Fee" min="0" step="1" max="100" required></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
    <button class="button" type="submit">Update Publishers</button>
    <div class="error"></div>
  </form>
</div>
<% include ../includes/end %>